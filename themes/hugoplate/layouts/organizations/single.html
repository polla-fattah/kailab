{{ define "main" }}
  {{ $organization := . }}
  {{ $lang := site.Language.Lang }}
  
  <!-- Debug information -->
  <div style="background: yellow; padding: 20px; margin: 20px;">
    <h3>Debug Info:</h3>
    <p>Organization Title: {{ $organization.Title }}</p>
    <p>Language: {{ $lang }}</p>
    <p>Organization Type: {{ $organization.Params.type }}</p>
    <p>Members Count: {{ len $organization.Params.memberIds }}</p>
    <p>Papers Count: {{ len $organization.Params.paperIds }}</p>
    <p>Projects Count: {{ len $organization.Params.projectIds }}</p>
    <p>Datasets Count: {{ len $organization.Params.datasetIds }}</p>
    
    <!-- Debug member lookup -->
    {{ if $organization.Params.memberIds }}
      <p>First Member ID: {{ index $organization.Params.memberIds 0 }}</p>
      {{ $authors := where site.RegularPages "Section" "authors" }}
      <p>Total authors found: {{ len $authors }}</p>
      {{ $member := where $authors "File.BaseFileName" (index $organization.Params.memberIds 0) }}
      <p>First member found: {{ len $member }}</p>
    {{ end }}
    
    <!-- Debug paper lookup -->
    {{ if $organization.Params.paperIds }}
      <p>First Paper ID: {{ index $organization.Params.paperIds 0 }}</p>
      {{ $papers := where site.RegularPages "Section" "papers" }}
      <p>Total papers found: {{ len $papers }}</p>
      {{ $paper := where $papers "File.BaseFileName" (index $organization.Params.paperIds 0) }}
      <p>First paper found: {{ len $paper }}</p>
    {{ end }}
  </div>
  
  <!-- Calculate papers from organization members -->
  {{ $allPapers := slice }}
  {{ if $organization.Params.memberIds }}
    {{ $papers := where site.RegularPages "Section" "papers" }}
    {{ range $papers }}
      {{ $currentPaper := . }}
      {{ if $currentPaper.Params.authors }}
        {{ range $currentPaper.Params.authors }}
          {{ $authorId := . }}
          {{ range $organization.Params.memberIds }}
            {{ if eq $authorId . }}
              {{ $allPapers = $allPapers | append $currentPaper }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  
  <!-- Organization found - display profile -->
  <section class="section-sm pb-0">
    <div class="container">
      <div class="row border-border dark:border-darkmode-border justify-center border-b pb-14">
        <div class="col-12 lg:col-8 mx-auto">
          <!-- Organization Header -->
          <header class="text-center mb-8">
            <h1 class="h2 mb-4">{{ $organization.Title }}</h1>
            <div class="flex flex-wrap justify-center gap-4 mb-4">
              <span class="inline-block bg-secondary/10 text-secondary dark:bg-darkmode-secondary/10 dark:text-darkmode-secondary text-sm px-3 py-1 rounded">
                {{ $organization.Params.type }}
              </span>
              <span class="text-text-light dark:text-darkmode-text-light">
                <i class="fas fa-map-marker-alt mr-2"></i>
                {{ $organization.Params.location }}
              </span>
              <span class="text-text-light dark:text-darkmode-text-light">
                <i class="fas fa-calendar mr-2"></i>
                Est. {{ $organization.Params.established }}
              </span>
            </div>
            {{ if $organization.Params.website }}
              <div class="mb-4">
                <a href="{{ $organization.Params.website }}" target="_blank" rel="noopener" 
                   class="btn btn-primary">
                  <i class="fas fa-external-link-alt mr-2"></i>
                  {{ if eq $lang "ku" }}سەردانی وێبسایت{{ else }}Visit Website{{ end }}
                </a>
              </div>
            {{ end }}
          </header>
          
          <!-- Organization Description -->
          <div class="content mb-8">
            <p class="text-lg">{{ $organization.Params.description }}</p>
          </div>
          
          <!-- Focus Areas -->
          {{ if $organization.Params.focus }}
            <div class="mb-8">
              <h3 class="h4 mb-4">{{ if eq $lang "ku" }}بوارە تایبەتەکان{{ else }}Focus Areas{{ end }}</h3>
              <div class="flex flex-wrap gap-2">
                {{ range $organization.Params.focus }}
                  <span class="inline-block bg-primary/10 text-primary dark:bg-darkmode-primary/10 dark:text-darkmode-primary text-sm px-3 py-1 rounded">
                    {{ . }}
                  </span>
                {{ end }}
              </div>
            </div>
          {{ end }}
        </div>
      </div>
    </div>
  </section>

  <!-- Organization Content -->
  <section class="section-sm">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10">
          
          <!-- Organization Members -->
          {{ if $organization.Params.memberIds }}
            <div class="mb-12">
                               <h3 class="h4 mb-6">{{ if eq $lang "ku" }}ئەندامەکان{{ else }}Organization Members{{ end }} ({{ len $organization.Params.memberIds }})</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {{ range $organization.Params.memberIds }}
                  {{ $memberId := . }}
                  {{ $authors := where site.RegularPages "Section" "authors" }}
                  {{ $member := where $authors "File.BaseFileName" $memberId }}
                  {{ if $member }}
                    {{ $member = index $member 0 }}
                    <div class="bg-light dark:bg-darkmode-light rounded-lg p-6 text-center">
                      <div class="mb-4">
                        {{ $avatar := "/images/avatar.png" }}
                        {{ partial "image" (dict "Src" $avatar "Size" "80x80" "Class" "rounded-full mx-auto" "Alt" $member.Title) }}
                      </div>
                      <h4 class="h6 mb-2">
                        <a href="{{ $member.RelPermalink }}" 
                           class="text-primary dark:text-darkmode-primary hover:underline">
                          {{ $member.Title }}
                        </a>
                      </h4>
                      {{ with $member.Params.email }}
                        <p class="text-sm text-text-light dark:text-darkmode-text-light mb-3">
                          <i class="fas fa-envelope mr-1"></i>
                          <a href="mailto:{{ . }}" class="hover:text-primary dark:hover:text-darkmode-primary">{{ . }}</a>
                        </p>
                      {{ end }}
                      {{ with $member.Params.description }}
                        <p class="text-sm">{{ truncate 100 . }}</p>
                      {{ end }}
                    </div>
                                       {{ end }}
                {{ end }}
              </div>
            </div>
          {{ end }}

          <!-- Organization Projects -->
          {{ if $organization.Params.projectIds }}
            <div class="mb-12">
                               <h3 class="h4 mb-6">{{ if eq $lang "ku" }}پڕۆژەکان{{ else }}Research Projects{{ end }} ({{ len $organization.Params.projectIds }})</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {{ range $organization.Params.projectIds }}
                  {{ $projectId := . }}
                  {{ $projects := where site.RegularPages "Section" "projects" }}
                  {{ $project := where $projects "File.BaseFileName" $projectId }}
                  {{ if $project }}
                    {{ $project = index $project 0 }}
                    <div class="bg-light dark:bg-darkmode-light rounded-lg p-6">
                      <h4 class="h6 mb-3">
                        <a href="{{ $project.RelPermalink }}" 
                           class="text-primary dark:text-darkmode-primary hover:underline">
                          {{ $project.Title }}
                        </a>
                      </h4>
                      <p class="text-sm text-text-light dark:text-darkmode-text-light mb-3">
                        {{ truncate 150 $project.Params.description }}
                      </p>
                      {{ if $project.Params.team }}
                        <div class="text-sm text-text-light dark:text-darkmode-text-light">
                          <span class="font-semibold">{{ if eq $lang "ku" }}تیم:{{ else }}Team:{{ end }}</span>
                          {{ range $index, $memberId := $project.Params.team }}
                            {{ if gt $index 0 }}, {{ end }}
                            {{ $authors := where site.RegularPages "Section" "authors" }}
                            {{ $member := where $authors "File.BaseFileName" $memberId }}
                            {{ if $member }}
                              {{ $member = index $member 0 }}
                              <a href="{{ $member.RelPermalink }}" class="hover:text-primary dark:hover:text-darkmode-primary">
                                {{ $member.Title }}
                              </a>
                            {{ else }}
                              {{ $memberId }}
                            {{ end }}
                          {{ end }}
                        </div>
                      {{ end }}
                    </div>
                                       {{ end }}
                {{ end }}
              </div>
            </div>
          {{ end }}

                      <!-- Organization Papers -->
          {{ if $organization.Params.paperIds }}
            <div class="mb-12">
              <h3 class="h4 mb-6">{{ if eq $lang "ku" }}وتارەکان{{ else }}Organization Papers{{ end }} ({{ len $organization.Params.paperIds }})</h3>
              <div class="space-y-6">
                {{ range $organization.Params.paperIds }}
                  {{ $paperId := . }}
                  {{ $papers := where site.RegularPages "Section" "papers" }}
                  {{ $paper := where $papers "File.BaseFileName" $paperId }}
                  {{ if $paper }}
                    {{ $paper = index $paper 0 }}
                    <div class="bg-light dark:bg-darkmode-light rounded-lg p-6">
                      <h4 class="h6 mb-3">
                        <a href="{{ $paper.RelPermalink }}" 
                           class="text-primary dark:text-darkmode-primary hover:underline">
                          {{ $paper.Title }}
                        </a>
                      </h4>
                      <div class="text-sm text-text-light dark:text-darkmode-text-light mb-3">
                        <span class="mr-4">
                          <i class="fas fa-calendar mr-1"></i>
                          {{ dateFormat "Jan 2, 2006" $paper.Params.publishedDate }}
                        </span>
                        <span class="mr-4">
                          <i class="fas fa-users mr-1"></i>
                          {{ if $paper.Params.authors }}
                            {{ range $index, $authorId := $paper.Params.authors }}
                              {{ if gt $index 0 }}, {{ end }}
                              {{ partial "author-display.html" $authorId }}
                            {{ end }}
                          {{ end }}
                        </span>
                      </div>
                      {{ with $paper.Params.abstract }}
                        <p class="text-sm mb-3">{{ truncate 300 . }}</p>
                      {{ end }}
                      {{ if $paper.Params.keywords }}
                        <div class="flex flex-wrap gap-2">
                          {{ range (first 5 $paper.Params.keywords) }}
                            <span class="inline-block bg-primary/10 text-primary dark:bg-darkmode-primary/10 dark:text-darkmode-primary text-xs px-2 py-1 rounded">
                              {{ . }}
                            </span>
                          {{ end }}
                        </div>
                      {{ end }}
                    </div>
                  {{ end }}
                {{ end }}
              </div>
            </div>
          {{ end }}

          <!-- Papers from Organization Members -->
          {{ if $allPapers }}
            {{ $sortedPapers := sort $allPapers "Params.publishedDate" "desc" }}
            <div class="mb-12">
              <h3 class="h4 mb-6">{{ if eq $lang "ku" }}وتارەکان لە ئەندامەکان{{ else }}Papers from Organization Members{{ end }} ({{ len $sortedPapers }})</h3>
              <div class="space-y-6">
                {{ range $sortedPapers }}
                  <div class="bg-light dark:bg-darkmode-light rounded-lg p-6">
                    <h4 class="h6 mb-3">
                      <a href="{{ .RelPermalink }}" 
                         class="text-primary dark:text-darkmode-primary hover:underline">
                        {{ .Title }}
                      </a>
                    </h4>
                    <div class="text-sm text-text-light dark:text-darkmode-text-light mb-3">
                      <span class="mr-4">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ dateFormat "Jan 2, 2006" .Params.publishedDate }}
                      </span>
                      <span class="mr-4">
                        <i class="fas fa-users mr-1"></i>
                        {{ if .Params.authors }}
                          {{ range $index, $authorId := .Params.authors }}
                            {{ if gt $index 0 }}, {{ end }}
                            {{ partial "author-display.html" $authorId }}
                          {{ end }}
                        {{ end }}
                      </span>
                    </div>
                    {{ with .Params.abstract }}
                      <p class="text-sm mb-3">{{ truncate 300 . }}</p>
                    {{ end }}
                    {{ if .Params.keywords }}
                      <div class="flex flex-wrap gap-2">
                        {{ range (first 5 .Params.keywords) }}
                          <span class="inline-block bg-primary/10 text-primary dark:bg-darkmode-primary/10 dark:text-darkmode-primary text-xs px-2 py-1 rounded">
                            {{ . }}
                          </span>
                        {{ end }}
                      </div>
                    {{ end }}
                  </div>
                {{ end }}
              </div>
            </div>
          {{ end }}

          <!-- Related Datasets -->
          {{ if $organization.Params.datasetIds }}
            <div class="mb-12">
              <h3 class="h4 mb-6">{{ if eq $lang "ku" }}داتاسێتەکان{{ else }}Research Datasets{{ end }} ({{ len $organization.Params.datasetIds }})</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {{ range $organization.Params.datasetIds }}
                  {{ $datasets := where site.RegularPages "Section" "datasets" }}
                  {{ $dataset := where $datasets "File.BaseFileName" . }}
                  {{ if $dataset }}
                    {{ $dataset = index $dataset 0 }}
                    <div class="bg-light dark:bg-darkmode-light rounded-lg p-6">
                      <h4 class="h6 mb-3">
                        <a href="{{ $dataset.RelPermalink }}" 
                           class="text-primary dark:text-darkmode-primary hover:underline">
                          {{ $dataset.Title }}
                        </a>
                      </h4>
                      <div class="text-sm text-text-light dark:text-darkmode-text-light mb-3">
                        <span class="mr-3">
                          <i class="fas fa-calendar mr-1"></i>
                          {{ dateFormat "2006" $dataset.Params.publishedDate }}
                        </span>
                        <span class="mr-3">
                          <i class="fas fa-hdd mr-1"></i>
                          {{ $dataset.Params.size }}
                        </span>
                      </div>
                      <p class="text-sm mb-3">{{ truncate 150 $dataset.Params.description }}</p>
                      {{ if $dataset.Params.url }}
                        <div class="mt-3">
                          <a href="{{ $dataset.Params.url }}" target="_blank" rel="noopener" 
                             class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download mr-1"></i>
                            {{ if eq $lang "ku" }}دەستگەیشتن بە داتاسێت{{ else }}Access Dataset{{ end }}
                          </a>
                        </div>
                      {{ end }}
                    </div>
                  {{ end }}
                {{ end }}
              </div>
            </div>
          {{ end }}
        </div>

        <!-- Sidebar -->
        <div class="col-12 lg:col-4">
          <div class="bg-light dark:bg-darkmode-light rounded-lg p-6 sticky top-4">
            <!-- Organization Stats -->
            <h3 class="h5 mb-4">{{ if eq $lang "ku" }}ئامارەکانی ڕێکخراو{{ else }}Organization Statistics{{ end }}</h3>
            <div class="space-y-3 mb-6">
              <div class="flex justify-between">
                <span>{{ if eq $lang "ku" }}جۆر:{{ else }}Type:{{ end }}</span>
                <span class="font-semibold">{{ $organization.Params.type }}</span>
              </div>
              <div class="flex justify-between">
                <span>{{ if eq $lang "ku" }}دامەزراو:{{ else }}Established:{{ end }}</span>
                <span class="font-semibold">{{ $organization.Params.established }}</span>
              </div>
              <div class="flex justify-between">
                <span>{{ if eq $lang "ku" }}ئەندامەکان:{{ else }}Members:{{ end }}</span>
                <span class="font-semibold">{{ len $organization.Params.memberIds }}</span>
              </div>
                                       <div class="flex justify-between">
                         <span>{{ if eq $lang "ku" }}پڕۆژەکان:{{ else }}Projects:{{ end }}</span>
                         <span class="font-semibold">{{ len $organization.Params.projectIds }}</span>
                       </div>
                                                 <div class="flex justify-between">
                          <span>{{ if eq $lang "ku" }}وتارەکان:{{ else }}Papers:{{ end }}</span>
                          <span class="font-semibold">{{ len $organization.Params.paperIds }}</span>
                        </div>
                       <div class="flex justify-between">
                         <span>{{ if eq $lang "ku" }}داتاسێتەکان:{{ else }}Datasets:{{ end }}</span>
                         <span class="font-semibold">{{ len $organization.Params.datasetIds }}</span>
                       </div>
            </div>

            <!-- Quick Actions -->
            <div class="space-y-2">
              {{ if $organization.Params.website }}
                <a href="{{ $organization.Params.website }}" target="_blank" rel="noopener" 
                   class="btn btn-primary btn-sm w-full">
                  <i class="fas fa-external-link-alt mr-1"></i>
                  {{ if eq $lang "ku" }}سەردانی وێبسایت{{ else }}Visit Website{{ end }}
                </a>
              {{ end }}
              <a href="{{ `/organizations/` | relLangURL }}" class="btn btn-outline-primary btn-sm w-full">
                <i class="fas fa-building mr-1"></i>
                {{ if eq $lang "ku" }}هەموو ڕێکخراوەکان{{ else }}All Organizations{{ end }}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{{ end }}